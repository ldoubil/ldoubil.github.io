name: 自动部署流程

on:
  workflow_dispatch:
  repository_dispatch:
    types: [manual-trigger]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: 🛎️ 检出代码
        uses: actions/checkout@v4
        with:
          repository: ldoubil/astro_blog
          token: ${{ secrets.GH_TOKEN }}

      - name: 🚀 配置Node环境
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: 📦 安装pnpm
        run: npm install -g pnpm@latest

      - name: 🔍 恢复依赖缓存
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: 📥 安装项目依赖
        run: pnpm install --frozen-lockfile

      - name: 🏗️ 构建生产版本
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: 📝 配置CNAME
        run: echo 'acg-n.cn' > dist/CNAME

      - name: 📦 打包构建产物
        run: tar --use-compress-program 'pigz -9' -cf dist.tar.gz dist/

      - name: 🚚 上传产物存档
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist.tar.gz

      - name: ⚙️ 配置Git信息
        run: |
          git config --global user.name '会做饭的二哈'
          git config --global user.email 'baikaiwen12@outlook.com'

      - name: 🚀 强制部署到Pages
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          cd dist
          git init -b blog
          git add -A
          git commit -m "自动化部署: $(date +'%Y-%m-%d %H:%M:%S')"
          git remote add origin https://${{ secrets.GH_TOKEN }}@github.com/ldoubil/ldoubil.github.io.git
          git push -f origin blog
