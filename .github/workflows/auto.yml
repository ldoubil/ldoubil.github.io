name: è‡ªåŠ¨éƒ¨ç½²æµç¨‹

on:
  workflow_dispatch:
  repository_dispatch:
    types: [manual-trigger]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ldoubil/astro_blog
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸš€ é…ç½®Nodeç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ğŸ“¦ å®‰è£…pnpm
        run: npm install -g pnpm@latest

      - name: ğŸ” æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ğŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: ğŸ“ é…ç½®CNAME
        run: echo 'acg-n.cn' > dist/CNAME

      - name: ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©
        run: tar --use-compress-program 'pigz -9' -cf dist.tar.gz dist/

      - name: ğŸšš ä¸Šä¼ äº§ç‰©å­˜æ¡£
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist.tar.gz

      - name: âš™ï¸ é…ç½®Gitä¿¡æ¯
        run: |
          git config --global user.name 'ä¼šåšé¥­çš„äºŒå“ˆ'
          git config --global user.email 'baikaiwen12@outlook.com'

      - name: ğŸš€ å¼ºåˆ¶éƒ¨ç½²åˆ°Pages
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          cd dist
          git init -b blog
          git add -A
          git commit -m "è‡ªåŠ¨åŒ–éƒ¨ç½²: $(date +'%Y-%m-%d %H:%M:%S')"
          git remote add origin https://${{ secrets.GH_TOKEN }}@github.com/ldoubil/ldoubil.github.io.git
          git push -f origin blog
