name: è‡ªåŠ¨éƒ¨ç½² ğŸš€

on:
  workflow_dispatch:
  repository_dispatch:
    types: [manual-trigger]

jobs:
  build:  # ä¿ç•™è‹±æ–‡å
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç åº“ ğŸ“¥
        uses: actions/checkout@v3
        with:
          repository: ldoubil/astro_blog
          token: ${{ secrets.GH_TOKEN }}

      - name: ç¼“å­˜ pnpm ğŸ—„ï¸
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: è®¾ç½® Node.js âš™ï¸
        uses: actions/setup-node@v3
        with:
          node-version: '20'  # ä½¿ç”¨ç¨³å®šçš„ LTS ç‰ˆæœ¬

      - name: å®‰è£… pnpm ğŸ“¦
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: å®‰è£…é¡¹ç›®ä¾èµ– ğŸ“‚
        run: pnpm install

      - name: æ„å»º Astro é™æ€æ–‡ä»¶ ğŸ—ï¸
        run: pnpm run build  # ä½¿ç”¨ pnpm æ„å»º

      - name: æ£€æŸ¥æ„å»ºç›®å½• ğŸ”
        run: |
          mkdir -p dist  # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          ls -la dist

      - name: åˆ›å»º CNAME æ–‡ä»¶ ğŸ“„
        run: echo 'acg-n.cn' > dist/CNAME  # ç¡®ä¿å†™å…¥åˆ° dist ç›®å½•

      - name: æ‰“åŒ…æ„å»ºäº§ç‰© ğŸ“¦
        run: tar -czvf dist.tar.gz dist/  # æ‰“åŒ… dist ç›®å½•

      - name: å‘å¸ƒæ‰“åŒ…æ–‡ä»¶ ğŸšš
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist.tar.gz

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯ ğŸ‘¤
        run: |
          git config --global user.name 'ldoubil'
          git config --global user.email 'baikaiwen12@outlook.com'

      - name: éƒ¨ç½²åˆ° GitHub Pages ğŸŒ
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          cd dist/  # è¿›å…¥æ­£ç¡®çš„æ„å»ºç›®å½•
          git init
          git add -A
          git commit -m "Create by workflows"
          # ç¡®ä¿ç›®æ ‡ä»“åº“å’Œåˆ†æ”¯æ­£ç¡®
          git remote add origin https://${{ secrets.GH_TOKEN }}@github.com/ldoubil/ldoubil.github.io.git
          git push origin HEAD:blog -f  # å¼ºåˆ¶æ¨é€åˆ° blog åˆ†æ”¯
